name: GitHub Script with External
on: push
    
jobs:
  external:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: get package.json
        id: data
        run: |
          echo "::set-output name=package::$(cat package.json | tr -d '\n')"
      - name: Test output
        run: |
          echo '${{ steps.data.outputs.package }}' | jq '.[]'
        env:
          JSON_DUMP: ${{ toJSON(steps.data.outputs.package) }}
      - name: Run eslint with eslint-plugin-vue-i18n
        run: |
          npm run lint:i18n -- -f json -o i18n-lint-raw-report.json
      - name: Filter eslint report
        run: |
          cat ./i18n-lint-raw-report.json | jq '[ .[] | select(.messages | length > 0) ] | .[] |= . + (.filePath | capture(".*packages\/(?<package>[a-zA-Z0-9_\\-]+)")) | group_by(.package)' > i18n-lint-report.json
      - name: Register i18n issues
        uses: actions/github-script@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const script = require(`${process.env.GITHUB_WORKSPACE}/external.js`)
            script({ github, context, core, io })
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
